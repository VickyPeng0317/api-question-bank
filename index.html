<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ‡‰ç”¨è¦åŠƒå¸« | åˆ·é¡Œç¶²ç«™</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind Config for Custom Colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        junior: '#3b82f6', // è—è‰²ä»£è¡¨åˆç´š
                        intermediate: '#8b5cf6', // ç´«è‰²ä»£è¡¨ä¸­ç´š
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        /* è‡ªå®šç¾©æ²è»¸ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>

<div id="app" class="min-h-screen flex flex-col">
    
    <!-- é ‚éƒ¨å°è¦½åˆ— (RWD æ”¶åˆç‰ˆ) -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <!-- å·¦å´ Logo (æ°¸é é¡¯ç¤º) -->
                <div class="flex-shrink-0 flex items-center cursor-pointer" @click="changeView('dashboard')">
                    <svg class="w-8 h-8 text-indigo-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                    <span class="font-bold text-xl text-gray-800 tracking-wider">AI æ‡‰ç”¨è¦åŠƒå¸« - åˆ·é¡Œå¹³å°</span>
                </div>

                <!-- æ¼¢å ¡æŒ‰éˆ• (åƒ…æ‰‹æ©Ÿç‰ˆé¡¯ç¤º) -->
                <div class="flex items-center md:hidden">
                    <button @click="isMobileMenuOpen = !isMobileMenuOpen" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
                        <span class="sr-only">Open main menu</span>
                        <!-- Icon when menu is closed -->
                        <svg v-if="!isMobileMenuOpen" class="block h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                        </svg>
                        <!-- Icon when menu is open -->
                        <svg v-else class="block h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- æ¡Œé¢ç‰ˆé¸å–® (åƒ…å¤§è¢å¹•é¡¯ç¤º) -->
                <div class="hidden md:flex md:items-center md:space-x-6">
                    <!-- é›£åº¦åˆ‡æ› -->
                    <div class="flex space-x-2 bg-gray-100 p-1 rounded-lg">
                        <button 
                            @click="switchLevel('junior')"
                            :class="[
                                'px-3 py-1 text-sm font-medium rounded-md transition-all duration-200',
                                currentLevel === 'junior' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'
                            ]"
                        >
                            åˆç´š (Junior)
                        </button>
                        <button 
                            @click="switchLevel('intermediate')"
                            :class="[
                                'px-3 py-1 text-sm font-medium rounded-md transition-all duration-200',
                                currentLevel === 'intermediate' ? 'bg-white text-purple-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'
                            ]"
                        >
                            ä¸­ç´š (Intermediate)
                        </button>
                    </div>

                    <!-- åŠŸèƒ½æŒ‰éˆ• -->
                    <div class="flex items-center space-x-4">
                        <button @click="changeView('dashboard')" :class="navBtnClass('dashboard')">å„€è¡¨æ¿</button>
                        <button @click="changeView('library')" :class="navBtnClass('library')">é¡Œåº«ç®¡ç†</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ‰‹æ©Ÿç‰ˆä¸‹æ‹‰é¸å–® (å±•é–‹æ™‚é¡¯ç¤º) -->
        <div v-show="isMobileMenuOpen" class="md:hidden border-t border-gray-200 bg-white shadow-lg">
            <div class="px-4 pt-4 pb-6 space-y-6">
                <!-- æ‰‹æ©Ÿç‰ˆï¼šé›£åº¦åˆ‡æ› -->
                <div class="space-y-2">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">é¸æ“‡é›£åº¦</p>
                    <div class="flex space-x-2 bg-gray-100 p-1 rounded-lg">
                        <button 
                            @click="switchLevel('junior')"
                            :class="[
                                'flex-1 px-3 py-2 text-sm font-medium rounded-md transition-all duration-200 text-center',
                                currentLevel === 'junior' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'
                            ]"
                        >
                            åˆç´š
                        </button>
                        <button 
                            @click="switchLevel('intermediate')"
                            :class="[
                                'flex-1 px-3 py-2 text-sm font-medium rounded-md transition-all duration-200 text-center',
                                currentLevel === 'intermediate' ? 'bg-white text-purple-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'
                            ]"
                        >
                            ä¸­ç´š
                        </button>
                    </div>
                </div>

                <!-- æ‰‹æ©Ÿç‰ˆï¼šåŠŸèƒ½å°è¦½ -->
                <div class="space-y-2">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">åŠŸèƒ½é¸å–®</p>
                    <button @click="changeView('dashboard')" 
                        :class="['w-full text-left px-4 py-3 rounded-md text-base font-medium', currentView === 'dashboard' ? 'bg-gray-100 text-indigo-600' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900']">
                        å„€è¡¨æ¿
                    </button>
                    <button @click="changeView('library')" 
                        :class="['w-full text-left px-4 py-3 rounded-md text-base font-medium', currentView === 'library' ? 'bg-gray-100 text-indigo-600' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900']">
                        é¡Œåº«ç®¡ç†
                    </button>
                </div>
            </div>
        </div>

        <!-- é›£åº¦æç¤ºæ¢ -->
        <div :class="['h-1 w-full', currentLevel === 'junior' ? 'bg-blue-500' : 'bg-purple-500']"></div>
    </nav>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- 1. å„€è¡¨æ¿ (Dashboard) -->
        <transition name="fade" mode="out-in">
            <div v-if="currentView === 'dashboard'" key="dashboard">
                <header class="mb-8 text-center md:text-left">
                    <h1 class="text-3xl font-bold text-gray-900">
                        {{ currentLevel === 'junior' ? 'åˆç´š' : 'ä¸­ç´š' }}å­¸ç¿’æ¦‚æ³
                    </h1>
                    <p class="mt-2 text-gray-600">é¸æ“‡ä¸‹æ–¹ç§‘ç›®é–‹å§‹æ¸¬é©—ã€‚</p>
                </header>

                <!-- çµ±è¨ˆå¡ç‰‡ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="p-5">
                            <div class="flex items-center">
                                <div :class="`flex-shrink-0 p-3 rounded-md ${levelColorClass} bg-opacity-10`">
                                    <svg :class="`h-6 w-6 ${levelTextColorClass}`" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">å¯ç”¨é¡Œåº«</dt>
                                        <dd class="text-2xl font-semibold text-gray-900">{{ currentLevelExams.length }} ä»½</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="p-5">
                            <div class="flex items-center">
                                <div :class="`flex-shrink-0 p-3 rounded-md ${levelColorClass} bg-opacity-10`">
                                    <svg :class="`h-6 w-6 ${levelTextColorClass}`" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">ç¸½é¡Œæ•¸</dt>
                                        <dd class="text-2xl font-semibold text-gray-900">{{ totalQuestionsInLevel }} é¡Œ</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è€ƒè©¦å…¥å£å€ -->
                <div v-if="currentLevelExams.length > 0">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 text-center md:text-left">é¸æ“‡æ¸¬é©—ç§‘ç›®</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="type in availableTypes" :key="type" 
                             class="bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow border border-gray-200 overflow-hidden group">
                            <div :class="`h-2 w-full ${levelColorClass}`"></div>
                            <div class="p-6">
                                <h3 class="text-lg font-bold text-gray-900 mb-2">{{ type }}</h3>
                                <p class="text-sm text-gray-500 mb-4">åŒ…å« {{ getQuestionCountByType(type) }} é¡Œ</p>
                                
                                <div class="space-y-2">
                                    <button @click="startQuizConfig(type)" 
                                        :class="`w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white ${levelColorClass} hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500`">
                                        é€²å…¥æ¸¬é©—
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ç©ºç‹€æ…‹å¼•å° -->
                <div v-else class="text-center py-12 bg-white rounded-lg shadow-sm">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">ç›®å‰æ²’æœ‰ {{ currentLevel === 'junior' ? 'åˆç´š' : 'ä¸­ç´š' }} é¡Œåº«</h3>
                    <p class="mt-1 text-sm text-gray-500">ç³»çµ±æ­£åœ¨è‡ªå‹•è¼‰å…¥é è¨­é¡Œåº«ï¼Œè«‹ç¨å€™...</p>
                </div>
            </div>

            <!-- 2. é¡Œåº«ç®¡ç† (Library & Settings) -->
            <div v-else-if="currentView === 'library'" key="library">
                <header class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <h1 class="text-2xl font-bold text-gray-900">é¡Œåº«ç®¡ç†ä¸­å¿ƒ</h1>
                    <button @click="changeView('dashboard')" class="text-gray-600 hover:text-gray-900 px-4 py-2 bg-gray-100 rounded-md sm:bg-transparent sm:p-0 w-full sm:w-auto text-center">è¿”å›</button>
                </header>

                <!-- æ‰‹å‹•åŒ¯å…¥èˆ‡å·²å®‰è£åˆ—è¡¨ -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- åŒ¯å…¥å€ -->
                    <div class="bg-white shadow rounded-lg p-6 h-fit">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">ğŸ“¥ æ‰‹å‹•åŒ¯å…¥ JSON</h3>
                        <div class="space-y-4">
                            <div class="border-2 border-dashed border-gray-300 rounded-md p-6 flex justify-center">
                                <div class="text-center w-full">
                                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                                    <div class="flex text-sm text-gray-600 justify-center mt-2">
                                        <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none w-full text-center py-2 sm:py-0">
                                            <span>é»æ“Šä¸Šå‚³æª”æ¡ˆ</span>
                                            <input id="file-upload" name="file-upload" type="file" class="sr-only" accept=".json" @change="handleFileUpload">
                                        </label>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">æ”¯æ´å–®ä¸€æˆ–é™£åˆ— JSON æ ¼å¼</p>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500 bg-gray-50 p-2 rounded">
                                <p class="font-bold">æç¤ºï¼š</p>
                                <p>è‹¥ JSON ä¸­ç„¡ <code>level</code> æ¬„ä½ï¼Œç³»çµ±å°‡æ ¹æ“šæ¨™é¡Œè‡ªå‹•åˆ¤æ–·ï¼ˆå«"åˆç´š"ç‚º Juniorï¼Œå«"ä¸­ç´š"ç‚º Intermediateï¼‰ã€‚</p>
                            </div>
                        </div>
                    </div>

                    <!-- å·²å®‰è£åˆ—è¡¨ (åˆ†ç´šé¡¯ç¤º) -->
                    <div class="bg-white shadow rounded-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-medium text-gray-900">ğŸ“š æœ¬åœ°é¡Œåº«åˆ—è¡¨</h3>
                            <button @click="clearAllData" class="text-xs text-red-600 hover:text-red-800 px-2 py-1 border border-red-200 rounded">æ¸…é™¤æ‰€æœ‰</button>
                        </div>
                        
                        <div class="space-y-6 max-h-[600px] overflow-y-auto pr-2">
                            <!-- åˆç´šé¡Œåº«å€å¡Š -->
                            <div>
                                <h4 class="text-sm font-bold text-blue-600 mb-3 uppercase tracking-wider border-b border-blue-100 pb-1 flex items-center">
                                    <span class="mr-2">ğŸ”µ</span> åˆç´š (Junior)
                                </h4>
                                <ul class="divide-y divide-gray-100">
                                    <!-- RWD Item -->
                                    <li v-for="exam in allJuniorExams" :key="exam.quiz_id" class="py-3 flex flex-col sm:flex-row justify-between items-start sm:items-center group hover:bg-gray-50 rounded px-2 transition-colors gap-3">
                                        <div class="w-full sm:w-auto">
                                            <p class="text-sm font-medium text-gray-900 break-words">{{ exam.title }}</p>
                                            <p class="text-xs text-gray-500 mt-1">{{ exam.type }} â€¢ {{ exam.questions.length }} é¡Œ</p>
                                        </div>
                                        <button @click="deleteExam(exam.quiz_id)" class="w-full sm:w-auto text-center text-sm sm:text-base text-gray-400 hover:text-red-500 transition-colors py-2 sm:py-0 border sm:border-0 rounded sm:rounded-none">
                                            <span class="sm:hidden">åˆªé™¤é¡Œåº«</span>
                                            <svg class="w-5 h-5 hidden sm:block mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        </button>
                                    </li>
                                    <li v-if="allJuniorExams.length === 0" class="text-xs text-gray-400 py-4 text-center bg-gray-50 rounded-lg border border-dashed border-gray-200">
                                        ç„¡åˆç´šé¡Œåº«
                                    </li>
                                </ul>
                            </div>

                            <!-- ä¸­ç´šé¡Œåº«å€å¡Š -->
                            <div>
                                <h4 class="text-sm font-bold text-purple-600 mb-3 uppercase tracking-wider border-b border-purple-100 pb-1 flex items-center">
                                    <span class="mr-2">ğŸŸ£</span> ä¸­ç´š (Intermediate)
                                </h4>
                                <ul class="divide-y divide-gray-100">
                                    <!-- RWD Item -->
                                    <li v-for="exam in allIntermediateExams" :key="exam.quiz_id" class="py-3 flex flex-col sm:flex-row justify-between items-start sm:items-center group hover:bg-gray-50 rounded px-2 transition-colors gap-3">
                                        <div class="w-full sm:w-auto">
                                            <p class="text-sm font-medium text-gray-900 break-words">{{ exam.title }}</p>
                                            <p class="text-xs text-gray-500 mt-1">{{ exam.type }} â€¢ {{ exam.questions.length }} é¡Œ</p>
                                        </div>
                                        <button @click="deleteExam(exam.quiz_id)" class="w-full sm:w-auto text-center text-sm sm:text-base text-gray-400 hover:text-red-500 transition-colors py-2 sm:py-0 border sm:border-0 rounded sm:rounded-none">
                                            <span class="sm:hidden">åˆªé™¤é¡Œåº«</span>
                                            <svg class="w-5 h-5 hidden sm:block mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                        </button>
                                    </li>
                                    <li v-if="allIntermediateExams.length === 0" class="text-xs text-gray-400 py-4 text-center bg-gray-50 rounded-lg border border-dashed border-gray-200">
                                        ç„¡ä¸­ç´šé¡Œåº«
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. è€ƒè©¦è¨­å®š (Setup Mode) -->
            <div v-else-if="currentView === 'setup'" key="setup" class="max-w-2xl mx-auto">
                <div class="bg-white shadow-lg rounded-xl overflow-hidden">
                    <div :class="`px-6 py-4 ${levelColorClass} text-white`">
                        <h2 class="text-xl font-bold">æ¸¬é©—è¨­å®š</h2>
                        <p class="text-sm opacity-90 break-words">{{ currentLevel === 'junior' ? 'åˆç´š' : 'ä¸­ç´š' }} - {{ selectedType }}</p>
                    </div>
                    <div class="p-6 space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">é¸æ“‡æ¨¡å¼</label>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div @click="setup.mode = 'random'" 
                                    :class="['cursor-pointer border rounded-lg p-4 flex flex-col items-center justify-center transition-all', setup.mode === 'random' ? 'border-indigo-500 ring-2 ring-indigo-200 bg-indigo-50' : 'border-gray-200 hover:border-gray-300']">
                                    <span class="text-2xl mb-2">ğŸ²</span>
                                    <span class="font-bold text-gray-900">éš¨æ™‚è€ƒ</span>
                                    <span class="text-xs text-gray-500 mt-1">éš¨æ©Ÿ 10 é¡Œ â€¢ å¿«é€Ÿç·´ç¿’</span>
                                </div>
                                <div @click="setup.mode = 'mock'" 
                                    :class="['cursor-pointer border rounded-lg p-4 flex flex-col items-center justify-center transition-all', setup.mode === 'mock' ? 'border-purple-500 ring-2 ring-purple-200 bg-purple-50' : 'border-gray-200 hover:border-gray-300']">
                                    <span class="text-2xl mb-2">ğŸ“</span>
                                    <span class="font-bold text-gray-900">æ¨¡æ“¬è€ƒ</span>
                                    <span class="text-xs text-gray-500 mt-1">å–®å·æ¨¡æ“¬ æˆ– ç¶œåˆ 50 é¡Œ</span>
                                </div>
                            </div>
                        </div>

                        <!-- æ¨¡æ“¬è€ƒç´°é …è¨­å®š -->
                        <div v-if="setup.mode === 'mock'" class="space-y-4 animate-fade-in-down">
                            <label class="block text-sm font-medium text-gray-700">æ¨¡æ“¬è€ƒç¯„åœ</label>
                            <select v-model="setup.mockSource" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md border text-ellipsis overflow-hidden">
                                <option value="all">ç¶œåˆæ¸¬é©— (éš¨æ©ŸæŠ½å– 50 é¡Œ)</option>
                                <option v-for="exam in examsByType" :key="exam.quiz_id" :value="exam.quiz_id">
                                    {{ exam.title }} (å…¨å· {{ exam.questions.length }} é¡Œ)
                                </option>
                            </select>
                        </div>

                        <div class="flex flex-col-reverse sm:flex-row justify-between pt-4 border-t gap-3 sm:gap-0">
                            <button @click="changeView('dashboard')" class="w-full sm:w-auto px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 text-center">
                                å–æ¶ˆ
                            </button>
                            <button @click="startQuiz" :class="`w-full sm:w-auto px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white ${levelColorClass} hover:opacity-90 text-center`">
                                é–‹å§‹æ¸¬é©—
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. æ¸¬é©—é€²è¡Œä¸­ (Quiz Mode) -->
            <div v-else-if="currentView === 'quiz'" key="quiz" class="max-w-3xl mx-auto">
                <div class="bg-white shadow-lg rounded-xl overflow-hidden min-h-[500px] flex flex-col">
                    <!-- é¡Œé ­ (RWD) -->
                    <div class="bg-gray-50 px-4 sm:px-6 py-4 border-b border-gray-200 flex flex-col-reverse sm:flex-row justify-between items-start sm:items-center gap-2">
                        <div class="w-full">
                            <div class="flex justify-between items-center sm:block">
                                <span class="text-xs font-semibold tracking-wider uppercase text-gray-500">
                                    é¡Œç›® {{ quizState.currentIndex + 1 }} / {{ quizState.questions.length }}
                                </span>
                                <!-- Mobile only Badge position if needed, keeping it consistent though -->
                            </div>
                            <!-- Updated Source Title with Truncation -->
                            <div class="text-xs text-gray-400 mt-0.5 truncate max-w-full" :title="currentQuestion.source_title">ä¾†æº: {{ currentQuestion.source_title }}</div>
                        </div>
                        <div :class="`px-2 py-1 text-xs rounded-full border self-start sm:self-auto ${levelBorderClass} ${levelTextColorClass}`">
                            {{ currentLevel === 'junior' ? 'åˆç´š' : 'ä¸­ç´š' }}
                        </div>
                    </div>

                    <!-- é¡Œç›®å…§å®¹ -->
                    <div class="p-4 sm:p-6 flex-grow">
                        <!-- Fix 1: Display question title if 'question' field is missing -->
                        <div class="text-lg text-gray-900 font-medium mb-6 leading-relaxed">
                             <!-- æ–°å¢ï¼šé¡Œè™Ÿ + é¡Œç›® (æ”¯æ´ questionText, question, title) -->
                            <span class="font-bold mr-1">{{ quizState.currentIndex + 1 }}.</span>
                            {{ currentQuestion.questionText || currentQuestion.question || currentQuestion.title }}
                        </div>

                        <div class="space-y-3">
                            <button 
                                v-for="(option, idx) in currentQuestion.options" 
                                :key="idx"
                                @click="selectAnswer(idx)" 
                                :disabled="quizState.answered"
                                :class="[
                                    'w-full text-left px-4 py-3 border rounded-lg transition-all duration-200 flex items-start sm:items-center',
                                    getOptionClass(idx)
                                ]"
                            >
                                <!-- Fix 2: Smart Badge (A/B or 1/2 or Key) -->
                                <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center border rounded-full mr-3 text-sm font-bold mt-0.5 sm:mt-0"
                                      :class="getOptionBadgeClass(idx)">
                                    {{ getOptionLabel(option, idx) }}
                                </span>
                                <!-- Fix 2: Option Content (Handle Object vs String) -->
                                <span class="leading-snug pt-1 sm:pt-0">{{ getOptionContent(option) }}</span>
                            </button>
                        </div>
                        
                        <!-- è§£æå€åŸŸ (ç­”é¡Œå¾Œé¡¯ç¤º) -->
                        <div v-if="quizState.answered" class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100 animate-pulse-once">
                            <!-- Fix 3: Show correct answer label properly -->
                            <p class="text-lg text-blue-800 font-bold mb-2">
                                ğŸ’¡ æ­£ç¢ºç­”æ¡ˆï¼š{{ getCorrectAnswerLabel() }}
                            </p>
                            <p class="text-sm text-blue-600 leading-relaxed" v-if="currentQuestion.explanation">
                                {{ currentQuestion.explanation }}
                            </p>
                        </div>
                    </div>

                    <!-- åº•éƒ¨æ§åˆ¶ -->
                    <div class="bg-gray-50 px-4 sm:px-6 py-4 border-t border-gray-200 flex justify-end">
                        <button v-if="!quizState.answered" class="w-full sm:w-auto px-4 py-2 bg-gray-300 text-white rounded-md cursor-not-allowed text-center">
                            è«‹é¸æ“‡ç­”æ¡ˆ
                        </button>
                        <button v-else @click="nextQuestion" :class="`w-full sm:w-auto px-6 py-2 text-white rounded-md shadow ${levelColorClass} hover:opacity-90 text-center`">
                            {{ isLastQuestion ? 'æŸ¥çœ‹çµæœ' : 'ä¸‹ä¸€é¡Œ' }} â†’
                        </button>
                    </div>
                </div>
            </div>

            <!-- 5. æ¸¬é©—çµæœ (Result Mode) -->
            <div v-else-if="currentView === 'result'" key="result" class="max-w-2xl mx-auto text-center px-4">
                <div class="bg-white shadow-lg rounded-xl p-6 sm:p-8">
                    <div class="mb-6">
                        <div class="w-24 h-24 mx-auto bg-indigo-100 rounded-full flex items-center justify-center mb-4">
                            <span class="text-3xl font-bold text-indigo-600">{{ Math.round((quizState.score / quizState.questions.length) * 100) }}</span>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">æ¸¬é©—å®Œæˆï¼</h2>
                        <p class="text-gray-600">ç­”å° {{ quizState.score }} é¡Œï¼Œå…± {{ quizState.questions.length }} é¡Œ</p>
                    </div>

                    <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                        <button @click="changeView('dashboard')" class="w-full sm:w-auto px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            å›åˆ°å„€è¡¨æ¿
                        </button>
                        <button @click="restartQuiz" :class="`w-full sm:w-auto px-6 py-2 text-white rounded-md shadow ${levelColorClass} hover:opacity-90`">
                            å†æ¸¬ä¸€æ¬¡
                        </button>
                    </div>
                    
                    <!-- éŒ¯é¡Œåˆ—è¡¨ (ç°¡å–®ç‰ˆ) -->
                    <div v-if="quizState.wrongAnswers.length > 0" class="mt-8 text-left">
                        <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">éŒ¯é¡Œæª¢è¨</h3>
                        <div class="space-y-6">
                            <div v-for="(item, idx) in quizState.wrongAnswers" :key="idx" class="bg-red-50 p-4 rounded-lg">
                                <!-- æ–°å¢ï¼šåŸå§‹é¡Œè™Ÿ + é¡Œç›® (æ”¯æ´ questionText) -->
                                <p class="font-medium text-gray-900 mb-2">
                                    <span class="font-bold mr-1">{{ item.originalIndex }}.</span>
                                    {{ item.question.questionText || item.question.question || item.question.title }}
                                </p>
                                <div class="text-sm text-red-600 mb-1">ä½ çš„ç­”æ¡ˆ: {{ getOptionContent(item.question.options[item.selected]) }}</div>
                                <div class="text-sm text-green-600 font-bold">æ­£ç¢ºç­”æ¡ˆ: {{ getCorrectAnswerContent(item.question) }}</div>
                                <!-- Updated Source Title -->
                                <div class="text-xs text-gray-400 mt-2 truncate">ä¾†æº: {{ item.question.source_title }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </transition>
    </main>
</div>

<script>
const { createApp, ref, computed, onMounted, reactive } = Vue;

const PRESET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS7zTXmLo28skYn_TubRuKZZr4209UL9sg5Lp-VZ4kQ-gnuG677fk6yisYWE4iSGpIlUpDqJ4Mi6owh/pub?output=csv";

createApp({
    setup() {
        const exams = ref([]);
        const currentView = ref('dashboard'); 
        const currentLevel = ref('junior'); 
        const isMobileMenuOpen = ref(false); // æ§åˆ¶æ‰‹æ©Ÿé¸å–®
        
        const selectedType = ref('');
        const setup = reactive({
            mode: 'random', 
            mockSource: 'all'
        });
        
        const quizState = reactive({
            questions: [],
            currentIndex: 0,
            score: 0,
            answered: false,
            selectedOptionIndex: null, // Stores the array index (0-based)
            wrongAnswers: [] 
        });

        // Computed Styles
        const levelColorClass = computed(() => currentLevel.value === 'junior' ? 'bg-blue-600' : 'bg-purple-600');
        const levelTextColorClass = computed(() => currentLevel.value === 'junior' ? 'text-blue-600' : 'text-purple-600');
        const levelBorderClass = computed(() => currentLevel.value === 'junior' ? 'border-blue-200' : 'border-purple-200');

        // Data Logic
        const currentLevelExams = computed(() => exams.value.filter(e => e.level === currentLevel.value));
        const allJuniorExams = computed(() => exams.value.filter(e => e.level === 'junior'));
        const allIntermediateExams = computed(() => exams.value.filter(e => e.level === 'intermediate'));
        
        const availableTypes = computed(() => {
            const types = new Set(currentLevelExams.value.map(e => e.type));
            return Array.from(types);
        });

        const examsByType = computed(() => currentLevelExams.value.filter(e => e.type === selectedType.value));

        const totalQuestionsInLevel = computed(() => currentLevelExams.value.reduce((acc, curr) => acc + curr.questions.length, 0));

        const getQuestionCountByType = (type) => {
             return currentLevelExams.value.filter(e => e.type === type).reduce((acc, curr) => acc + curr.questions.length, 0);
        };

        // Lifecycle
        onMounted(() => {
            loadExamsFromStorage();
            autoLoadPresets();
        });

        // --- Functions: Data Loading ---
        const autoLoadPresets = async () => {
            try {
                const response = await fetch(PRESET_CSV_URL);
                if (!response.ok) throw new Error('Failed to fetch CSV');
                const text = await response.text();
                
                const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                const presets = lines.slice(1).map(line => {
                    const parts = line.split(',');
                    if (parts.length < 4) return null;
                    return {
                        name: parts[0].trim(),
                        level: parts[1].trim(),
                        type: parts[2].trim(),
                        url: parts[3].trim()
                    };
                }).filter(item => item !== null);
                
                let hasUpdates = false;
                for (const preset of presets) {
                    if (!isExamImported(preset.name)) {
                        try {
                            const res = await fetch(preset.url);
                            if (res.ok) {
                                const data = await res.json();
                                const list = Array.isArray(data) ? data : [data];
                                list.forEach(exam => {
                                    if (!exam.level && preset.level) exam.level = preset.level;
                                    exam.level = detectLevel(exam.title, exam.level);
                                    
                                    if (!exams.value.some(e => e.quiz_id === exam.quiz_id)) {
                                        exams.value.push(exam);
                                        hasUpdates = true;
                                    }
                                });
                            }
                        } catch (err) {
                            console.warn(`Failed to auto-load preset: ${preset.name}`, err);
                        }
                    }
                }
                
                if (hasUpdates) saveExamsToStorage();

            } catch (e) {
                console.error("Error auto-loading presets:", e);
            }
        };

        const loadExamsFromStorage = () => {
            const stored = localStorage.getItem('ai_exams_db');
            if (stored) {
                try { exams.value = JSON.parse(stored); } catch (e) { console.error(e); }
            }
        };

        const saveExamsToStorage = () => localStorage.setItem('ai_exams_db', JSON.stringify(exams.value));
        const detectLevel = (title, givenLevel) => givenLevel || (title.includes('ä¸­ç´š') ? 'intermediate' : 'junior');
        const isExamImported = (title) => exams.value.some(e => e.title === title);

        const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    addExamToDb(json);
                    alert("åŒ¯å…¥æˆåŠŸï¼");
                    currentView.value = 'library';
                } catch (err) { alert("JSON æ ¼å¼éŒ¯èª¤"); }
            };
            reader.readAsText(file);
        };

        const addExamToDb = (examData) => {
            const list = Array.isArray(examData) ? examData : [examData];
            list.forEach(exam => {
                exam.level = detectLevel(exam.title, exam.level);
                if (!exams.value.some(e => e.quiz_id === exam.quiz_id)) exams.value.push(exam);
            });
            saveExamsToStorage();
        };

        const deleteExam = (id) => {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ä»½é¡Œåº«å—ï¼Ÿ')) {
                exams.value = exams.value.filter(e => e.quiz_id !== id);
                saveExamsToStorage();
            }
        };

        const clearAllData = () => {
            if(confirm('è­¦å‘Šï¼šé€™å°‡æ¸…é™¤æ‰€æœ‰å·²ä¸‹è¼‰çš„é¡Œåº«èˆ‡ç´€éŒ„ï¼Œç¢ºå®šå—ï¼Ÿ')) {
                localStorage.removeItem('ai_exams_db');
                exams.value = [];
            }
        };

        // --- Functions: Navigation & UI ---
        
        const switchLevel = (lvl) => {
            currentLevel.value = lvl;
            currentView.value = 'dashboard';
            isMobileMenuOpen.value = false; // Close menu after switching
        };

        const changeView = (view) => {
            currentView.value = view;
            isMobileMenuOpen.value = false; // Close menu after navigation
        };

        const startQuizConfig = (type) => {
            selectedType.value = type;
            setup.mode = 'random';
            setup.mockSource = 'all';
            currentView.value = 'setup';
        };

        const startQuiz = () => {
            let pool = [];
            if (setup.mode === 'random') {
                const targets = examsByType.value;
                targets.forEach(exam => {
                    // Injected source_title here
                    exam.questions.forEach(q => pool.push({ ...q, source_id: exam.quiz_id, source_title: exam.title }));
                });
                pool = shuffleArray(pool).slice(0, 10);
            } else if (setup.mode === 'mock') {
                if (setup.mockSource === 'all') {
                    const targets = examsByType.value;
                    targets.forEach(exam => {
                        // Injected source_title here
                        exam.questions.forEach(q => pool.push({ ...q, source_id: exam.quiz_id, source_title: exam.title }));
                    });
                    pool = shuffleArray(pool).slice(0, 50);
                } else {
                    const targetExam = exams.value.find(e => e.quiz_id === setup.mockSource);
                    if (targetExam) {
                        // Injected source_title here
                        pool = targetExam.questions.map(q => ({ ...q, source_id: targetExam.quiz_id, source_title: targetExam.title }));
                    }
                }
            }

            if (pool.length === 0) {
                alert("æ²’æœ‰è¶³å¤ çš„é¡Œç›®å¯ä»¥ç”¢ç”Ÿæ¸¬é©—");
                return;
            }

            quizState.questions = pool;
            quizState.currentIndex = 0;
            quizState.score = 0;
            quizState.answered = false;
            quizState.selectedOptionIndex = null;
            quizState.wrongAnswers = [];
            currentView.value = 'quiz';
        };

        const currentQuestion = computed(() => quizState.questions[quizState.currentIndex]);
        const isLastQuestion = computed(() => quizState.currentIndex === quizState.questions.length - 1);

        // --- Core Fixes for Options & Answers ---

        // Helper: Extract label (A/B/C/D or 1/2/3/4 or Key from Object)
        const getOptionLabel = (option, idx) => {
            if (typeof option === 'object' && option !== null) {
                return option.v || option.key || option.label || (idx + 1);
            }
            // Default to A,B,C,D if plain string
            return ['A','B','C','D'][idx] || (idx + 1);
        };

        // Helper: Extract display text
        const getOptionContent = (option) => {
            if (typeof option === 'object' && option !== null) {
                return option.n || option.value || option.text || JSON.stringify(option);
            }
            return option;
        };

        // Check if a specific index is the correct answer
        const isCorrectOption = (idx) => {
            const ans = currentQuestion.value.answer;
            const option = currentQuestion.value.options[idx];
            
            // 1. Compare by Index (common in some JSONs, usually 1-based in older systems, 0-based in some)
            // Note: The previous logic assumed ans is 1-based index (ans - 1). 
            // We'll stick to loose comparison for flexibility.
            if (ans == (idx + 1)) return true;
            
            // 2. Compare by Value/Key (if option is object)
            if (typeof option === 'object' && option !== null) {
                // If answer is "1" and option.v is "1"
                if (option.v == ans) return true;
                if (option.key == ans) return true;
            }

            // 3. Compare by Label (A, B, C, D)
            const label = ['A','B','C','D'][idx];
            if (ans === label) return true;

            return false;
        };

        const selectAnswer = (idx) => {
            if (quizState.answered) return;
            
            quizState.selectedOptionIndex = idx;
            quizState.answered = true;
            
            if (isCorrectOption(idx)) {
                quizState.score++;
            } else {
                quizState.wrongAnswers.push({
                    question: currentQuestion.value,
                    selected: idx,
                    originalIndex: quizState.currentIndex + 1 // Record the question number (1-based)
                });
            }
        };

        const getOptionClass = (idx) => {
            if (!quizState.answered) {
                return quizState.selectedOptionIndex === idx ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200 hover:border-indigo-300';
            }
            // Answered state
            if (isCorrectOption(idx)) {
                return 'border-green-500 bg-green-50 ring-1 ring-green-500'; // Correct always green
            }
            if (quizState.selectedOptionIndex === idx) {
                return 'border-red-500 bg-red-50 ring-1 ring-red-500'; // Selected wrong one red
            }
            return 'border-gray-200 opacity-50';
        };

        const getOptionBadgeClass = (idx) => {
            if (!quizState.answered) return 'border-gray-300 text-gray-500 bg-white';
            
            if (isCorrectOption(idx)) return 'bg-green-500 border-green-500 text-white';
            if (quizState.selectedOptionIndex === idx) return 'bg-red-500 border-red-500 text-white';
            
            return 'border-gray-300 text-gray-500 bg-white';
        };

        const getCorrectAnswerLabel = () => {
            const options = currentQuestion.value.options;
            // Find which index is correct
            const correctIdx = options.findIndex((_, idx) => isCorrectOption(idx));
            if (correctIdx !== -1) {
                const opt = options[correctIdx];
                return getOptionLabel(opt, correctIdx) + (typeof opt === 'object' ? '' : ''); // Just return label
            }
            return currentQuestion.value.answer; // Fallback
        };
        
        const getCorrectAnswerContent = (question) => {
             // For result view
             const correctIdx = question.options.findIndex((_, i) => {
                // Determine correctness contextually
                const ans = question.answer;
                const option = question.options[i];
                if (ans == (i + 1)) return true;
                if (typeof option === 'object' && (option.v == ans || option.key == ans)) return true;
                if (ans === ['A','B','C','D'][i]) return true;
                return false;
             });
             
             if (correctIdx !== -1) {
                 return getOptionContent(question.options[correctIdx]);
             }
             return "ç„¡æ³•åˆ¤å®š";
        };

        const nextQuestion = () => {
            if (isLastQuestion.value) {
                currentView.value = 'result';
            } else {
                quizState.currentIndex++;
                quizState.answered = false;
                quizState.selectedOptionIndex = null;
            }
        };

        const restartQuiz = () => startQuiz();
        
        const shuffleArray = (array) => {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        };

        const navBtnClass = (viewName) => currentView.value === viewName 
            ? 'text-gray-900 px-3 py-2 rounded-md text-sm font-medium bg-gray-100' 
            : 'text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium';

        return {
            exams, currentView, currentLevel, selectedType, setup, quizState, isMobileMenuOpen,
            currentLevelExams, allJuniorExams, allIntermediateExams, availableTypes, examsByType,
            totalQuestionsInLevel, currentQuestion, isLastQuestion,
            levelColorClass, levelTextColorClass, levelBorderClass,
            switchLevel, changeView, handleFileUpload, deleteExam, clearAllData, startQuizConfig, startQuiz,
            selectAnswer, nextQuestion, restartQuiz, navBtnClass, getQuestionCountByType,
            // New Helpers
            getOptionLabel, getOptionContent, getOptionClass, getOptionBadgeClass, getCorrectAnswerLabel, getCorrectAnswerContent
        };
    }
}).mount('#app');
</script>
</body>
</html>